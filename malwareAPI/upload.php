<?php

session_start();
$apiKey = 'qph6wrg193b9e5c0x06lr3xa7b9d9adfwvps4dbp29f5d076ovef3jd2a14159ee';
$secretKey = 'e842c3dd9fc4de0c6e01da7eb4e1d2a3821f6fd665065e0f';
$baseurl = 'https://hybrid-analysis.com/api/v2/';
// $filePath = 'imain.7z';

// if (file_exists($filePath)) {
//     $sha256Hash = hash_file('sha256', $filePath);
// }

// print_r($sha256Hash);
// die;

echo '<pre>';
print_r($_POST);
print_r($_FILES);

// Check if the form was submitted
if (isset($_POST["submit"])) {
    $targetDirectory = "uploads/"; // Directory where you want to store uploaded files
    $targetFile = $targetDirectory . basename($_FILES["fileToUpload"]["name"]); // Full path to the uploaded file
    
    // Check if the file already exists
    if (file_exists($targetFile)) {
        echo "File already exists.";
    } else {

        $maxFileSize = 10 * 1024 * 1024; // 10 MB in bytes

        // Check file size (you can adjust the file size limit as needed)
        if ($_FILES["fileToUpload"]["size"] > $maxFileSize) {
            echo "File is too large.";
        } else {
            // Allow only certain file types (in this example, we allow JPEG and PNG files)
            $allowedExtensions = array("jpg", "jpeg", "png");
            $fileExtension = strtolower(pathinfo($targetFile, PATHINFO_EXTENSION));
            $fileTempPath = $_FILES["fileToUpload"]["tmp_name"];

            if (!empty($fileTempPath) && file_exists($fileTempPath)) {
                // move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $targetFile);
                $hash = hash_file('sha256', $fileTempPath);
                
                $ch = curl_init();
            
                // $hash = 'bbb26bfc7bc961c72f3d391433c3602874ed447ca4ec4ff5e8b141c2b3f8a86f';
                // $hash = hash_file('sha256', $filePath);
                // $hash = hash_file('sha256', $_FILES["fileToUpload"]["name"]);
                // print_r($hash);
                // print_r($_FILES["fileToUpload"]["name"]);
                // die;
                $url = $baseurl.'overview/'.$hash;
                
                $headers = [
                    'Accept: application/json',
                    'User-Agent: Falcon Sandbox',
                    'Api-Key: ' . $apiKey,
                    'Content-Type: application/x-www-form-urlencoded',
                ];

                curl_setopt($ch, CURLOPT_URL, $url);
                curl_setopt($ch, CURLOPT_HTTPGET, true);
                curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                
                $response = curl_exec($ch);
                
                if ($response === false) {
                    echo 'cURL Error: ' . curl_error($ch);
                } else {
                    // echo $response;
                    $response = json_decode($response, true);
                }
                print_r($response);die;
                $_SESSION['malicious'] = (!empty($response)) ? $response: "";
                
                curl_close($ch);
                // die;
                header("Location: index.php");
                exit; // Make sure to exit to prevent further execution
            }
        }
    }
}
?>
